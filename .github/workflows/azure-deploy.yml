name: Deploy to Azure Container Apps

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Permite execu√ß√£o manual

env:
  AZURE_RESOURCE_GROUP: gr-avidata
  AZURE_CONTAINER_APP: api-avidata
  AZURE_CONTAINER_REGISTRY: acravidata
  IMAGE_NAME: avidata-api

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      AVIDATA_DB_USERNAME: ${{ secrets.AVIDATA_DB_USERNAME }}
      AVIDATA_DB_PASSWORD: ${{ secrets.AVIDATA_DB_PASSWORD }}
      AVIDATA_JWT_SECRET: ${{ secrets.AVIDATA_JWT_SECRET }}
    
    permissions:
      contents: read
      id-token: write  # Necess√°rio para autentica√ß√£o Azure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Log in to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set Azure Subscription
      run: |
        az account set --subscription "c8dc7cf3-00d6-470b-97f3-480d1a2b8685"
        echo "‚úì Azure subscription set successfully"
    
    - name: Build and Push image to Azure Container Registry
      run: |
        IMAGE_TAG=${{ github.sha }}
        echo "Building image with tag: $IMAGE_TAG"
        
        az acr build \
          --registry ${{ env.AZURE_CONTAINER_REGISTRY }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --image ${{ env.IMAGE_NAME }}:$IMAGE_TAG \
          --image ${{ env.IMAGE_NAME }}:latest \
          --file Dockerfile \
          .
    
    - name: Deploy to Azure Container Apps
      run: |
        IMAGE_TAG=${{ github.sha }}
        ACR_LOGIN_SERVER=$(az acr show --name ${{ env.AZURE_CONTAINER_REGISTRY }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query loginServer --output tsv)
        
        # Usar m√©todo compat√≠vel com GitHub Actions para env vars com caracteres especiais
        az containerapp update \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --image $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:$IMAGE_TAG \
          --set-env-vars \
            "AVIDATA_DB_USERNAME=${{ env.AVIDATA_DB_USERNAME }}" \
            "AVIDATA_DB_PASSWORD=${{ env.AVIDATA_DB_PASSWORD }}" \
            "AVIDATA_JWT_SECRET=${{ env.AVIDATA_JWT_SECRET }}"
    
    - name: Get Application URL
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "properties.configuration.ingress.fqdn" \
          --output tsv)
        echo "üöÄ Application deployed successfully!"
        echo "üìç URL: https://$APP_URL"
        echo "üìä Swagger: https://$APP_URL/swagger-ui.html"
