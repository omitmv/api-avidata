name: Deploy to Azure Container Apps

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Permite execu√ß√£o manual

env:
  AZURE_RESOURCE_GROUP: avidata-rg
  AZURE_CONTAINER_APP: api-avidata
  AZURE_CONTAINER_REGISTRY: acravidata
  IMAGE_NAME: avidata-api

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Necess√°rio para autentica√ß√£o Azure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Log in to Azure Container Registry
      run: |
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}
    
    - name: Build and push Docker image
      run: |
        IMAGE_TAG=${{ github.sha }}
        ACR_LOGIN_SERVER=$(az acr show --name ${{ env.AZURE_CONTAINER_REGISTRY }} --query loginServer --output tsv)
        
        docker build -t ${{ env.IMAGE_NAME }}:$IMAGE_TAG .
        docker tag ${{ env.IMAGE_NAME }}:$IMAGE_TAG $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:$IMAGE_TAG
        docker tag ${{ env.IMAGE_NAME }}:$IMAGE_TAG $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest
        
        docker push $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:$IMAGE_TAG
        docker push $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:latest
    
    - name: Deploy to Azure Container Apps
      run: |
        IMAGE_TAG=${{ github.sha }}
        ACR_LOGIN_SERVER=$(az acr show --name ${{ env.AZURE_CONTAINER_REGISTRY }} --query loginServer --output tsv)
        
        az containerapp update \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --image $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:$IMAGE_TAG
    
    - name: Get Application URL
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "properties.configuration.ingress.fqdn" \
          --output tsv)
        echo "üöÄ Application deployed successfully!"
        echo "üìç URL: https://$APP_URL"
        echo "üìä Swagger: https://$APP_URL/swagger-ui.html"
